name: Reusable Workflow

on:
  workflow_call:
    inputs:
      deploy_to:
        required: true
        type: string
      databricks_host:
        required: true
        type: string
      databricks_token:
        required: true
        type: string

jobs:
  deploy:
    runs-on: windows-latest
    environment: DEV_WORKSPACE_NAME

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Install Az PowerShell Module
      - name: Install Az PowerShell Module
        shell: pwsh
        run: |
          Install-Module -Name Az -AllowClobber -Scope CurrentUser -Force
          Get-InstalledModule -Name Az  # Verify installation

      # Install Databricks CLI
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
          az extension add --name databricks
      - name: Debug Azure Secrets
        shell: pwsh
        run: |
          Write-Host "Checking Secrets..."
          if ("${{ secrets.AZURE_CLIENT_SECRET }}" -eq "") { Write-Error "AZURE_CLIENT_SECRET is empty!" ; exit 1 }
          if ("${{ secrets.AZURE_CLIENT_ID }}" -eq "") { Write-Error "AZURE_CLIENT_ID is empty!" ; exit 1 }
          if ("${{ secrets.AZURE_TENANT_ID }}" -eq "") { Write-Error "AZURE_TENANT_ID is empty!" ; exit 1 }

          
      - name: Authenticate with Azure using PowerShell
        shell: pwsh
        run: |
          if ("${{ secrets.AZURE_CLIENT_SECRET }}" -eq "") {
            Write-Error "AZURE_CLIENT_SECRET is empty!"
            exit 1
          }
          $secureSecret = ConvertTo-SecureString "${{ secrets.AZURE_CLIENT_SECRET }}" -AsPlainText -Force
          $creds = New-Object System.Management.Automation.PSCredential("${{ secrets.AZURE_CLIENT_ID }}", $secureSecret)
          Connect-AzAccount -ServicePrincipal -TenantId "${{ secrets.AZURE_TENANT_ID }}" -Credential $creds
      

      - name: Deploy Notebooks to ${{ inputs.deploy_to }} Environment
        env:
          DATABRICKS_HOST: ${{ inputs.databricks_host }}
          DATABRICKS_TOKEN: ${{ inputs.databricks_token }}
        run: |
          databricks workspace import_dir --overwrite notebooks /Workspace/notebooks
